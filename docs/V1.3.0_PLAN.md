# ChatCompass v1.3.0 开发计划

> **版本**: v1.3.0  
> **分支**: `feature/v1.3.0-gui-and-async`  
> **开始日期**: 2026-01-17  
> **目标**: GUI界面 + 系统托盘监控 + 异步爬取队列

---

## 📋 版本目标

### 核心特性

1. **GUI界面** - 全面支持图形化操作
2. **系统托盘监控** - 自动识别复制的AI对话链接
3. **异步爬取队列** - 后台处理,实时进度显示

---

## 🎯 功能规划

### Feature 1: GUI基础框架

**目标**: 构建完整的图形化界面

**技术栈**:
- 主框架: PyQt6 (跨平台,功能强大) 或 Tkinter (内置,轻量)
- 图标: Material Design Icons
- 主题: 支持亮色/暗色切换

**界面组件**:
```
主窗口 (MainWindow)
├── 菜单栏 (MenuBar)
│   ├── 文件 (导入/导出/退出)
│   ├── 编辑 (搜索/删除)
│   ├── 视图 (主题切换)
│   └── 帮助 (关于/文档)
│
├── 工具栏 (ToolBar)
│   ├── 添加按钮
│   ├── 搜索框
│   └── 刷新按钮
│
├── 主内容区 (ContentArea)
│   ├── 对话列表 (ConversationList)
│   │   ├── 表格视图 (TableView)
│   │   └── 卡片视图 (CardView)
│   │
│   └── 详情面板 (DetailPanel)
│       ├── 标题/链接/平台
│       ├── 统计信息
│       └── 对话内容
│
└── 状态栏 (StatusBar)
    ├── 任务队列状态
    ├── 数据统计
    └── AI服务状态
```

**子任务**:
- [ ] 选择GUI框架 (PyQt6推荐)
- [ ] 创建主窗口类
- [ ] 实现菜单栏和工具栏
- [ ] 实现对话列表组件
- [ ] 实现详情面板
- [ ] 添加主题切换功能
- [ ] 单元测试 (UI组件独立测试)

**测试要求**:
- 组件渲染测试
- 事件处理测试
- 数据绑定测试
- 主题切换测试

---

### Feature 2: 系统托盘监控

**目标**: 监听剪贴板,自动识别AI对话链接

**功能描述**:
1. 后台监听系统剪贴板
2. 识别支持的AI对话URL (ChatGPT/Claude/DeepSeek)
3. 弹出提示窗口询问是否添加
4. 支持快捷键操作 (Enter确认, Esc取消)

**技术方案**:

```python
# 托盘监控架构
SystemTray
├── ClipboardMonitor (剪贴板监听器)
│   ├── check_clipboard() - 定时检查
│   ├── validate_url() - URL验证
│   └── notify_new_link() - 通知
│
├── TrayIcon (托盘图标)
│   ├── show_notification() - 系统通知
│   └── show_menu() - 右键菜单
│
└── PromptDialog (提示对话框)
    ├── show_link_info() - 显示链接信息
    ├── confirm_add() - 确认添加
    └── cancel() - 取消
```

**URL识别规则**:
```python
SUPPORTED_PATTERNS = {
    'chatgpt': r'https://chatgpt\.com/share/[\w-]+',
    'claude': r'https://claude\.ai/share/[\w-]+',
    'deepseek': r'https://chat\.deepseek\.com(/coder)?/share/[\w-]+',
}
```

**子任务**:
- [ ] 实现剪贴板监听
- [ ] 实现URL模式匹配
- [ ] 创建系统托盘图标
- [ ] 实现提示对话框
- [ ] 添加配置选项 (启用/禁用监控)
- [ ] 添加快捷键支持
- [ ] 单元测试 (监听器/验证器)

**测试要求**:
- 剪贴板监听测试
- URL验证测试
- 通知显示测试
- 用户交互测试
- 性能测试 (CPU/内存占用)

---

### Feature 3: 异步爬取队列

**目标**: 后台异步处理爬取任务,实时进度显示

**功能描述**:
1. 任务队列管理 (添加/暂停/取消)
2. 异步并发爬取 (控制并发数)
3. 实时进度显示 (进度条/状态更新)
4. 错误处理和重试机制
5. 任务历史记录

**技术方案**:

```python
# 异步队列架构
AsyncTaskQueue
├── TaskQueue (任务队列)
│   ├── add_task() - 添加任务
│   ├── process_queue() - 处理队列
│   └── cancel_task() - 取消任务
│
├── AsyncScraper (异步爬虫)
│   ├── scrape_async() - 异步爬取
│   ├── emit_progress() - 发送进度
│   └── handle_error() - 错误处理
│
├── TaskStatus (任务状态管理)
│   ├── PENDING - 等待中
│   ├── PROCESSING - 处理中
│   ├── COMPLETED - 已完成
│   ├── FAILED - 失败
│   └── CANCELLED - 已取消
│
└── ProgressWidget (进度显示组件)
    ├── update_progress() - 更新进度
    ├── show_status() - 显示状态
    └── show_error() - 显示错误
```

**并发控制**:
- 最大并发数: 3个任务
- 使用asyncio控制并发
- 任务优先级队列

**进度回调**:
```python
class ScraperProgress:
    def __init__(self):
        self.stage = None  # 'init' | 'loading' | 'parsing' | 'saving'
        self.percent = 0   # 0-100
        self.message = ""  # 状态消息
        
    def update(self, stage, percent, message):
        # 更新进度并触发UI更新
        pass
```

**子任务**:
- [ ] 实现任务队列类
- [ ] 改造爬虫为异步模式
- [ ] 实现进度回调机制
- [ ] 创建进度显示组件
- [ ] 添加任务控制功能 (暂停/取消/重试)
- [ ] 实现任务历史记录
- [ ] 单元测试 (队列/异步爬虫)
- [ ] 性能测试 (并发/内存)

**测试要求**:
- 队列管理测试
- 异步爬取测试
- 进度回调测试
- 并发控制测试
- 错误处理测试
- 取消操作测试
- 内存泄漏测试

---

### Feature 4: GUI对话管理界面

**目标**: 在GUI中实现完整的对话管理功能

**功能列表**:
1. **列表显示** - 表格/卡片两种视图
2. **搜索过滤** - 实时搜索,关键词高亮
3. **查看详情** - 双击查看完整对话
4. **删除确认** - 批量删除支持
5. **标签管理** - 添加/编辑/删除标签
6. **导出功能** - 导出为Markdown/JSON

**界面布局**:
```
对话管理界面
├── 搜索栏
│   ├── 搜索框 (关键词)
│   ├── 过滤器 (平台/分类/标签)
│   └── 排序选项 (时间/标题)
│
├── 列表区
│   ├── 表格视图
│   │   ├── 复选框
│   │   ├── ID/标题/平台/时间
│   │   └── 操作按钮
│   │
│   └── 卡片视图
│       ├── 卡片项
│       │   ├── 标题
│       │   ├── 摘要
│       │   ├── 标签
│       │   └── 操作按钮
│       └── 分页控件
│
└── 详情面板
    ├── 标题栏 (编辑/删除/导出)
    ├── 元信息 (链接/平台/时间/统计)
    ├── 标签编辑器
    └── 对话内容 (可滚动)
```

**子任务**:
- [ ] 实现表格视图
- [ ] 实现卡片视图
- [ ] 实现搜索和过滤
- [ ] 实现详情面板
- [ ] 实现标签编辑器
- [ ] 实现导出功能
- [ ] 实现批量操作
- [ ] 单元测试 (各组件)

**测试要求**:
- 列表渲染测试
- 搜索功能测试
- 过滤功能测试
- 详情显示测试
- 标签管理测试
- 导出功能测试

---

## 📁 项目结构

```
ChatCompass/
├── gui/                          # GUI模块 (新增)
│   ├── __init__.py
│   ├── main_window.py            # 主窗口
│   ├── conversation_list.py      # 对话列表
│   ├── detail_panel.py           # 详情面板
│   ├── tray_monitor.py           # 托盘监控
│   ├── task_queue.py             # 任务队列
│   ├── progress_widget.py        # 进度组件
│   ├── dialogs/                  # 对话框
│   │   ├── add_dialog.py
│   │   ├── prompt_dialog.py
│   │   └── settings_dialog.py
│   └── resources/                # 资源文件
│       ├── icons/
│       ├── styles/
│       └── themes/
│
├── scrapers/                     # 爬虫模块 (改造)
│   ├── async_scraper_base.py     # 异步爬虫基类 (新增)
│   ├── chatgpt_scraper.py        # 改造为异步
│   ├── claude_scraper.py         # 改造为异步
│   └── deepseek_scraper.py       # 改造为异步
│
├── tests/                        # 测试模块
│   ├── gui/                      # GUI测试 (新增)
│   │   ├── test_main_window.py
│   │   ├── test_tray_monitor.py
│   │   ├── test_task_queue.py
│   │   └── test_components.py
│   ├── e2e/                      # E2E测试
│   │   ├── test_gui_workflow.py  # GUI工作流测试
│   │   └── test_async_scraping.py
│   └── unit/
│       ├── test_clipboard_monitor.py
│       └── test_async_scraper.py
│
├── main_gui.py                   # GUI入口 (新增)
├── requirements-gui.txt          # GUI依赖 (新增)
└── config.py                     # 配置 (更新)
```

---

## 🧪 测试策略

### 测试驱动开发 (TDD)

**原则**: 先写测试,再写代码

**测试层次**:
1. **单元测试** - 组件/函数级别
2. **集成测试** - 模块间交互
3. **E2E测试** - 完整用户流程
4. **性能测试** - 响应时间/资源占用

### 单元测试覆盖

**GUI组件测试**:
```python
# tests/gui/test_main_window.py
def test_main_window_init():
    """测试:主窗口初始化"""
    
def test_menu_actions():
    """测试:菜单操作"""
    
def test_toolbar_buttons():
    """测试:工具栏按钮"""
```

**托盘监控测试**:
```python
# tests/gui/test_tray_monitor.py
def test_clipboard_detection():
    """测试:剪贴板检测"""
    
def test_url_validation():
    """测试:URL验证"""
    
def test_notification_display():
    """测试:通知显示"""
```

**异步队列测试**:
```python
# tests/gui/test_task_queue.py
def test_add_task():
    """测试:添加任务"""
    
def test_process_queue():
    """测试:处理队列"""
    
def test_cancel_task():
    """测试:取消任务"""
    
def test_concurrent_tasks():
    """测试:并发任务"""
```

### E2E测试场景

**场景1: 完整添加流程**
```python
def test_e2e_add_conversation():
    """
    E2E测试:添加对话完整流程
    1. 启动GUI
    2. 点击添加按钮
    3. 输入URL
    4. 等待爬取完成
    5. 验证对话已添加
    6. 关闭GUI
    """
```

**场景2: 托盘监控流程**
```python
def test_e2e_tray_monitor():
    """
    E2E测试:托盘监控流程
    1. 启动托盘监控
    2. 复制AI对话链接
    3. 验证弹窗出现
    4. 点击确认
    5. 验证对话已添加
    """
```

**场景3: 异步队列流程**
```python
def test_e2e_async_queue():
    """
    E2E测试:异步队列流程
    1. 添加3个任务到队列
    2. 验证并发处理
    3. 验证进度更新
    4. 等待全部完成
    5. 验证结果
    """
```

### 测试覆盖率目标

| 模块 | 目标覆盖率 | 关键测试点 |
|------|----------|-----------|
| GUI组件 | 85%+ | 渲染/事件/数据绑定 |
| 托盘监控 | 90%+ | 剪贴板/验证/通知 |
| 异步队列 | 95%+ | 队列/并发/错误处理 |
| 异步爬虫 | 90%+ | 爬取/回调/异常 |
| 总体 | 85%+ | - |

---

## 🔒 安全和质量要求

### 代码规范

**强制要求**:
1. ✅ **SQL参数化查询** - 禁止字符串拼接
2. ✅ **输入验证** - 所有用户输入必须验证
3. ✅ **异常处理** - 完整的try-catch覆盖
4. ✅ **类型注解** - 所有函数添加类型提示
5. ✅ **文档字符串** - 所有公开API添加docstring

**示例**:
```python
def add_task(self, url: str, priority: int = 0) -> str:
    """
    添加爬取任务到队列
    
    Args:
        url: AI对话URL
        priority: 任务优先级 (0-10, 默认0)
        
    Returns:
        str: 任务ID
        
    Raises:
        ValueError: URL格式无效
        QueueFullError: 队列已满
    """
    # 1. 验证输入
    if not self._validate_url(url):
        raise ValueError(f"Invalid URL: {url}")
    
    # 2. 创建任务
    task = Task(url=url, priority=priority)
    
    # 3. 添加到队列
    self.queue.put(task)
    
    return task.id
```

### 测试要求

**提交前检查**:
```bash
# 1. 运行所有测试
pytest tests/ -v

# 2. 检查覆盖率
pytest tests/ --cov=. --cov-report=html

# 3. 类型检查
mypy gui/ scrapers/

# 4. 代码风格
flake8 gui/ scrapers/
black gui/ scrapers/ --check
```

---

## 📚 文档要求

### 必须更新的文档

1. **README.md / README_EN.md** (必须同步)
   - 更新功能特性列表
   - 添加GUI安装说明
   - 添加GUI使用截图
   - 更新版本号和测试统计

2. **CHANGELOG.md**
   - 详细的v1.3.0变更说明
   - 功能对比表
   - 升级指南

3. **新增文档**:
   - `docs/GUI_GUIDE.md` - GUI使用指南
   - `docs/TRAY_MONITOR.md` - 托盘监控说明
   - `docs/ASYNC_QUEUE.md` - 异步队列文档
   - `TESTING_GUIDE_v1.3.0.md` - 测试指南

### 文档同步检查

**提交前验证**:
```bash
# 检查版本号一致性
grep -E "Version-v[0-9]+\.[0-9]+\.[0-9]+" README.md README_EN.md

# 检查测试统计一致性
grep -E "Tests-[0-9]+" README.md README_EN.md
```

---

## 📅 开发时间线

### Phase 1: GUI基础 (3-4天)
- Day 1: 框架选择和主窗口搭建
- Day 2: 对话列表和详情面板
- Day 3: 菜单栏和工具栏
- Day 4: 单元测试和调试

### Phase 2: 托盘监控 (2-3天)
- Day 1: 剪贴板监听和URL验证
- Day 2: 托盘图标和通知
- Day 3: 单元测试和E2E测试

### Phase 3: 异步队列 (3-4天)
- Day 1: 任务队列实现
- Day 2: 异步爬虫改造
- Day 3: 进度显示和错误处理
- Day 4: 单元测试和性能测试

### Phase 4: 集成和优化 (2-3天)
- Day 1: 组件集成
- Day 2: E2E测试
- Day 3: 性能优化和Bug修复

### Phase 5: 文档和发布 (1-2天)
- Day 1: 文档编写和README同步
- Day 2: 最终测试和发布准备

**总计: 11-16天**

---

## ✅ 完成标准

### 功能完成标准
- [ ] GUI所有核心功能正常工作
- [ ] 托盘监控稳定运行,CPU占用<5%
- [ ] 异步队列支持并发,无内存泄漏
- [ ] 所有单元测试通过 (85%+覆盖率)
- [ ] 所有E2E测试通过
- [ ] README.md和README_EN.md完全同步
- [ ] CHANGELOG.md完整记录

### 质量标准
- [ ] 无SQL注入漏洞
- [ ] 无内存泄漏
- [ ] 启动时间<3秒
- [ ] UI响应时间<100ms
- [ ] 爬取速度不低于CLI版本

### 文档标准
- [ ] 所有公开API有文档字符串
- [ ] 用户指南包含截图
- [ ] 升级指南清晰完整
- [ ] 测试指南可复现

---

## 🚀 开始开发

### 环境准备

```bash
# 1. 确认在正确分支
git branch --show-current
# 应该显示: feature/v1.3.0-gui-and-async

# 2. 安装GUI依赖
pip install -r requirements-gui.txt

# 3. 运行测试
pytest tests/ -v

# 4. 开始开发!
```

---

**准备就绪,开始v1.3.0开发! 🚀**
