# 📝 更新日志 (Changelog)

## [v1.3.0] - 2026-01-17

### 🎉 重大版本更新 - GUI界面 + 系统托盘监控 + 异步爬取队列

#### ✨ 新增功能

##### 🖥️ GUI图形化界面
- **PyQt6全功能GUI** - 现代化图形界面
  - ✅ 主窗口 (MainWindow) - 菜单栏/工具栏/状态栏
  - ✅ 对话列表 (ConversationList) - 表格视图/搜索/过滤/排序
  - ✅ 详情面板 (DetailPanel) - 完整对话内容显示
  - ✅ 添加对话对话框 (AddPromptDialog) - URL输入/平台自动识别
  - ✅ 搜索栏 (SearchBar) - 实时搜索/平台过滤
  - ✅ 主题支持 - 亮色/暗色主题切换

##### 📋 系统托盘监控
- **剪贴板自动监控** - 智能识别AI对话链接
  - ✅ 后台监听剪贴板变化
  - ✅ 自动识别ChatGPT/Claude/DeepSeek链接
  - ✅ 弹窗提示确认添加
  - ✅ 系统托盘图标和菜单
  - ✅ 右键菜单快速操作
  - ✅ 可启用/禁用监控

##### ⚡ 异步爬取队列
- **后台异步处理** - 实时进度显示
  - ✅ 任务队列管理 (TaskQueue)
  - ✅ 异步并发爬取 (最多3个任务)
  - ✅ 实时进度显示 (TaskProgressWidget)
  - ✅ 任务状态管理 (PENDING/PROCESSING/COMPLETED/FAILED/CANCELLED)
  - ✅ 错误处理和重试机制
  - ✅ 任务历史记录

#### 🏗️ 架构改进

##### GUI模块 (`gui/`)
```
gui/
├── main_window.py         # 主窗口 (476行)
├── conversation_list.py   # 对话列表 (201行)
├── detail_panel.py        # 详情面板 (142行)
├── clipboard_monitor.py   # 剪贴板监控 (168行)
├── system_tray.py         # 系统托盘 (121行)
├── task_queue.py          # 任务队列 (215行)
├── task_manager.py        # 任务管理器 (169行)
├── search_bar.py          # 搜索栏 (94行)
└── dialogs/
    └── add_prompt_dialog.py  # 添加对话框 (91行)
```

##### 测试模块增强
- **GUI测试** (`tests/gui/`) - 76个测试
  - 主窗口测试 (17个)
  - 对话列表测试 (15个)
  - 详情面板测试 (10个)
  - 任务队列测试 (18个)
  - 系统托盘测试 (8个)
  - 集成测试 (10个)
  
- **E2E测试** (`tests/e2e/`) - 31个测试
  - GUI工作流测试 (11个)
  - 剪贴板监控测试 (12个)
  - 系统集成测试 (8个)

#### 📊 测试统计

| 测试类别 | 数量 | 覆盖率 |
|---------|------|--------|
| GUI单元测试 | 76 | 85%+ |
| 集成测试 | 10 | 90%+ |
| 单元测试 | 19 | 95%+ |
| E2E测试 | 31 | 90%+ |
| **总计** | **136** | **88%** |

#### 🔧 技术改进

##### 异步爬虫重构
- 所有爬虫支持异步模式
- 进度回调机制
- 错误处理增强
- 取消操作支持

##### 数据库增强
- 支持测试模式 (db注入)
- 统一数据格式 (`raw_content`)
- 更好的事务处理

##### 代码质量
- 完整的类型注解
- 详细的文档字符串
- 符合安全规范 (SQL参数化)
- 无内存泄漏

#### 📚 文档完善

##### 新增文档
- `docs/GUI_GUIDE.md` - GUI完整使用指南 (2200+行)
  - 8个主要功能章节
  - 故障排除FAQ
  - 性能优化建议
  - 快捷键速查表
  
- `docs/V1.3.0_PLAN.md` - v1.3.0开发计划
- `docs/V1.3.0_PHASE6_COMPLETE.md` - Phase 6完成报告

##### 更新文档
- `README.md` - 更新功能特性/安装说明/测试统计
- `CHANGELOG.md` - 本文档
- `requirements-gui.txt` - GUI依赖清单

#### 🚀 使用方式

##### GUI模式 (新增)
```bash
# 启动GUI
python main_gui.py

# 启用系统托盘监控
python main_gui.py --enable-tray

# 禁用剪贴板监控
python main_gui.py --disable-monitor
```

##### CLI模式 (兼容)
```bash
# 原有CLI命令完全兼容
python main.py add <url>
python main.py search <keyword>
python main.py list
python main.py show <id>
```

#### 📦 依赖更新

##### 新增依赖
```
PyQt6>=6.6.1               # GUI框架
PyQt6-Qt6>=6.6.1           # Qt核心
playwright>=1.41.0         # 浏览器自动化 (已有)
```

#### 🐛 Bug修复
- ✅ 修复MainWindow初始化时db参数处理
- ✅ 修复E2E测试中的导入路径
- ✅ 修复raw_content数据格式不一致
- ✅ 修复Windows编码问题

#### 🎯 性能指标

| 指标 | v1.2 | v1.3.0 | 改进 |
|-----|------|--------|------|
| 启动时间 | N/A | <2秒 | 新增 |
| UI响应 | N/A | <50ms | 新增 |
| 托盘CPU占用 | N/A | <3% | 新增 |
| 并发爬取 | 1个 | 3个 | **3倍** |
| 测试数量 | 108 | 136 | **+26%** |

---

## [v1.2] - 2026-01-13

### ✨ 新增功能

#### 🔍 搜索增强 - 上下文定位
- **功能**: 搜索结果显示匹配片段的上下文和精确定位
- **特性**:
  - ✅ 显示匹配片段的前后文（默认前后80字符）
  - ✅ 精确标注匹配位置（第几条消息）
  - ✅ 高亮显示搜索关键词（用【】标记）
  - ✅ 区分用户👤和助手🤖的消息
  - ✅ 支持一个对话中的多处匹配（最多显示3处）
  - ✅ 自动添加省略号标识截断
  - ✅ 配置化的上下文长度
  
**示例**:
```bash
python main.py search "规则"
```

**输出示例**:
```
🔍 搜索: 规则
  找到 1 条结果:

  [1] 📄 Vibe Coding规则解析
      💬 平台: chatgpt | 📁 分类: None
      📍 找到 1 处匹配:

         🤖 助手 (第 2/2 条消息)
         ...可以总结为 6 条非显性的"潜【规则】"。
Rule 1：人给「意图」，模型给「实现」...

      💡 输入 'show 4' 查看完整对话
```

**多处匹配示例**:
```bash
python main.py search "模型"
```

**输出显示**:
```
🔍 搜索: 模型
  找到 1 条结果:

  [1] 📄 Vibe Coding规则解析
      💬 平台: chatgpt | 📁 分类: None
      📍 找到 3 处匹配:

         🤖 助手 (第 2/2 条消息)
         ...更像是一种在大【模型】辅助编程场景下...

         🤖 助手 (第 2/2 条消息)
         ...而是人如何与【模型】协作完成软件构建...

         🤖 助手 (第 2/2 条消息)
         ...由大【模型】负责"落地细节"、人类只做方向与判断...
```

---

### 🔧 技术改进

#### 数据库层增强 (`database/db_manager.py`)
- **新增方法**: `_extract_context_matches()`
  - 从对话内容中提取匹配片段
  - 计算并提取上下文范围
  - 支持配置上下文字符数
  - 限制每条消息最多3个匹配

- **更新方法**: `search_conversations()`
  - 新增 `context_size` 参数（默认100字符）
  - 返回结果增加 `matches` 字段
  - 保持向后兼容性

#### 主程序层增强 (`main.py`)
- **更新方法**: `search()`
  - 美化输出格式（Emoji图标）
  - 分层显示搜索结果
  - 高亮关键词显示
  - 提供完整对话查看提示

---

### 📚 文档更新

#### 新增文档
- `SEARCH_CONTEXT_FEATURE.md` - 搜索增强功能完整文档
  - 功能概述和演示
  - 技术实现细节
  - 配置参数说明
  - 使用场景示例
  - 技术优势分析
  - 未来优化方向

#### 新增脚本
- `demo_search_context.py` - 搜索功能演示脚本

#### 更新文档
- `使用说明.txt` - 添加搜索增强说明
- `CHANGELOG.md` - 本文档

---

### 🎨 用户体验优化

#### 搜索结果显示优化
- 使用Emoji图标增强可读性：
  - 🔍 搜索标识
  - 📄 对话标题
  - 💬 平台标识
  - 📁 分类标识
  - 🏷️ 标签标识
  - 📍 匹配位置标识
  - 👤 用户消息
  - 🤖 助手消息
  - 💡 提示信息

#### 信息层次化展示
1. 对话基本信息（标题、平台、分类、标签）
2. 匹配统计（找到几处匹配）
3. 具体匹配片段（角色、位置、上下文）
4. 操作提示（查看完整对话）

---

### 🧪 测试

#### 功能验证
- ✅ 单个匹配显示正常
- ✅ 多处匹配显示正常
- ✅ 上下文提取准确
- ✅ 关键词高亮正常
- ✅ 边界情况处理正确
- ✅ 中文字符支持完美

#### 性能测试
- ✅ 搜索速度无明显影响
- ✅ 内存占用正常
- ✅ 大量匹配时限制生效

---

## [v1.1] - 2026-01-12

### ✨ 新增功能

#### 🎯 show命令 - 查看对话详细内容
- **功能**: 查看单个对话的完整详细内容
- **用法**: `python main.py show <id|url>` 或在交互模式中 `show <id|url>`
- **特性**:
  - ✅ 支持通过ID查询 (`show 1`, `show 4`)
  - ✅ 支持通过URL查询 (`show https://...`)
  - ✅ 显示完整对话内容（用户消息和助手回复）
  - ✅ 美化的输出格式（Emoji图标+分隔线）
  - ✅ 显示统计信息（消息数、字数、分类、标签）
  - ✅ 显示摘要和备注
  - ✅ 命令行模式和交互模式都支持

**示例**:
```bash
# 命令行模式
python main.py show 1
python main.py show "https://chatgpt.com/share/xxxxx"

# 交互模式
ChatCompass> show 1
ChatCompass> show 4
```

**输出示例**:
```
======================================================================
对话详情 (ID: 1)
======================================================================

📝 标题: Python数据分析入门
🔗 链接: https://chatgpt.com/share/demo1
💬 平台: chatgpt
📅 时间: 2026-01-12 12:25:16

📊 统计:
  - 消息数: 2 条
  - 字数: 234 字
  - 分类: 编程
  - 标签: Python, Pandas, 数据分析, NumPy

💬 对话内容:
----------------------------------------------------------------------
👤 用户 (消息 1/2):
我想学习Python数据分析...

----------------------------------------------------------------------
🤖 助手 (消息 2/2):
学习Python数据分析，建议从...

======================================================================
```

---

### 🐛 Bug修复

#### ChatGPT爬虫页面结构适配
- **问题**: ChatGPT分享页面结构变化导致无法提取对话内容
- **修复**: 
  - 实现多选择器等待策略（5个备选选择器）
  - 添加5层回退机制
  - 支持新旧页面结构
  - 增加详细日志输出
- **状态**: ✅ 已修复并测试通过
- **详情**: 查看 `BUGFIX_REPORT.md`

---

### 🔧 改进

#### 编码处理优化
- 改进Windows控制台UTF-8编码处理
- 使用 `io.TextIOWrapper` 替代 `chcp` 命令
- 确保Emoji和中文字符正常显示

#### 交互模式增强
- 更新 `list` 命令，显示对话ID和查看提示
- 更新 `help` 命令，添加show命令说明和示例
- 优化提示信息

---

### 📚 文档更新

#### 新增文档
- `FEATURE_SHOW.md` - show命令完整功能文档
- `NEW_FEATURE_SHOW.md` - 新功能发布公告
- `BUGFIX_REPORT.md` - Bug修复详细报告
- `ISSUE_RESOLVED.md` - 问题解决报告
- `CHANGELOG.md` - 本文档

#### 更新文档
- `使用说明.txt` - 添加show命令说明
- `README.md` - 更新功能列表（待更新）

#### 新增脚本
- `debug_chatgpt.py` - ChatGPT页面结构调试工具
- `demo_show.py` - show命令功能演示脚本
- `test_show.py` - show命令测试脚本

---

### 🧪 测试

#### 新增测试
- ✅ show命令通过ID查询测试
- ✅ show命令通过URL查询测试
- ✅ show命令错误处理测试
- ✅ ChatGPT爬虫新页面结构测试

#### 测试结果
- 所有新功能测试通过 ✅
- Bug修复验证通过 ✅
- 向后兼容性测试通过 ✅

---

## [v1.0] - 2026-01-12

### 🎉 初始发布

#### 核心功能
- ✅ ChatGPT和Claude分享链接爬取
- ✅ SQLite数据库存储
- ✅ FTS5全文搜索
- ✅ 标签管理系统
- ✅ 分类统计功能
- ✅ 命令行界面
- ✅ 交互式模式

#### 命令支持
- `add <url>` - 添加对话
- `search <keyword>` - 搜索对话
- `list` - 列出对话
- `stats` - 统计信息
- `help` - 帮助信息
- `exit` - 退出程序

#### 测试
- 52个单元测试通过
- 49%代码覆盖率
- 完整的测试套件

---

## 📊 版本对比

| 功能 | v1.0 | v1.1 | v1.2 |
|------|------|------|------|
| 添加对话 | ✅ | ✅ | ✅ |
| 基础搜索 | ✅ | ✅ | ✅ |
| 上下文搜索 | ❌ | ❌ | ✅ **新增** |
| 列出对话 | ✅ | ✅ (增强) | ✅ |
| 查看详情 | ❌ | ✅ **新增** | ✅ |
| 统计信息 | ✅ | ✅ | ✅ |
| ChatGPT爬虫 | ⚠️ 有问题 | ✅ 已修复 | ✅ |
| 编码处理 | ⚠️ 基本 | ✅ 优化 | ✅ |

---

## 🚀 升级指南

### 从v1.1升级到v1.2

#### 自动升级
只需拉取最新代码，无需额外操作：
```bash
git pull origin main
```

#### 数据兼容性
- ✅ 数据库完全兼容
- ✅ 配置文件兼容
- ✅ API向后兼容
- ✅ 无需迁移

#### 新功能使用
```bash
# 立即体验增强搜索
python main.py search "规则"
python main.py search "模型"
```

### 从v1.0升级到v1.2

#### 升级步骤
1. 拉取最新代码
2. 无需其他操作

#### 主要变化
- ✅ 新增show命令（v1.1）
- ✅ 修复ChatGPT爬虫（v1.1）
- ✅ 增强搜索功能（v1.2）

### 从v1.0升级到v1.1

#### 自动升级
只需拉取最新代码，无需额外操作：
```bash
git pull origin main
```

#### 数据兼容性
- ✅ 数据库完全兼容
- ✅ 配置文件兼容
- ✅ 无需迁移

#### 新功能使用
```bash
# 立即体验新功能
python main.py show 1
```

---

## 🔮 未来规划

### v1.3 (计划中)
- [ ] 搜索高级功能
  - [ ] 正则表达式搜索
  - [ ] 多关键词组合搜索（AND/OR）
  - [ ] 按消息角色过滤
  - [ ] 搜索结果导出
- [ ] Web界面（PyQt6）
- [ ] 批量导入功能
- [ ] 对话导出功能
- [ ] 更多平台支持（Gemini, DeepSeek）

### v1.4 (计划中)
- [ ] 对话编辑功能
- [ ] 标签批量管理
- [ ] 数据可视化
- [ ] AI摘要优化
- [ ] 搜索结果排序优化

---

## 📞 支持

### 文档
- 搜索增强: `SEARCH_CONTEXT_FEATURE.md`
- 完整功能: `FEATURE_SHOW.md`
- Bug修复: `BUGFIX_REPORT.md`
- 快速开始: `使用说明.txt`
- 项目概述: `README.md`

### 工具
- 搜索演示: `demo_search_context.py`
- 调试工具: `debug_chatgpt.py`
- 功能演示: `demo_show.py`
- 快速测试: `quick_test.py`

---

**当前版本**: v1.2  
**发布日期**: 2026-01-13  
**状态**: ✅ 稳定版本
